{
    "collab_server" : "",
    "contents" : "output$featureSelectHelp <- renderUI({\n  tags$div(\n      \n  )\n\"<p>\n            <h2>Set up the subgroup data</h2>\n            Select the contrast, covariates, and outcomes. \n            If this is a one arm study set contrast to empty, otherwise\n            select the control arm in the treatment column.\n            After selecting outcomes, please specify the type of each.\n            After setting all variables, click on \\\"<i>Save feature setting</i>\\\".\n          </p>\")\n})\noutput$renderFeatureOutputs <- renderUI({\n  # update feature panel\n  if(length(values$sid.data) == 0) {\n    return()\n  }\n  \n  features <- colnames(values$sid.data$data)\n  \n  if(\"contrast\" %in% names(values$sid.data)) {\n    trt <- features[values$sid.data$contrast]\n    controls <- unique(values$sid.data$data[, trt, with = FALSE])\n    if (\"control\" %in% names(values$sid.data)) {\n      control_selected <- values$sid.data$control\n    } else {\n      control_selected <- NULL\n    }\n  } else {\n    trt <- \"\"\n    controls <- c()\n    control_selected <- NULL\n  }\n\n  if(\"covariates\" %in% names(values$sid.data)) {\n    covariates <- features[values$sid.data$covariates]\n  } else {\n    covariates <- c()\n  }\n  \n  if(\"outcomes\" %in% names(values$sid.data)) {\n    outcomes <- features[values$sid.data$outcomes]\n  } else {\n    outcomes <- c()\n  }\n  \n  tags$div(\n    id = \"featureSelectDiv\",\n    fluidRow(\n      column(\n        width = 6,\n        selectInput(inputId = \"selectContrast\", \n                    label = \"select contrast\",\n                    choices = c(\"\", setdiff(features, c(covariates, outcomes))),\n                    selected = trt)\n      ),\n      column(\n        width = 6,\n        selectInput(inputId = \"selectControl\", \n                    label = \"control\",\n                    choices = controls,\n                    selected = control_selected)\n        )\n    ),\n    fluidRow(\n      column(\n        width = 4,\n        multiInput(inputId = \"selectCovariates\", \n                   label = \"select covariates\",\n                   choices = setdiff(features, c(trt, outcomes)),\n                   selected = covariates)\n      ),\n      column(\n        width = 4,\n        multiInput(inputId = \"selectOutcomes\", \n                   label = \"select outcomes\",\n                   choices = setdiff(features, c(trt, covariates)),\n                   selected = outcomes)\n      ),\n      column(\n        width = 4,\n        uiOutput(outputId = \"selectOutcomesTypes\")\n      )\n    )\n    \n  )\n})\n\noutput$selectOutcomesTypes <- renderUI({\n  OUTCOME_TYPES <- c(\"numeric\", \"binary\", \"count\", \"survival\")\n  outcomes <- input$selectOutcomes\n  print(\"hello\")\n  if (is.null(outcomes) || length(outcomes) == 0) {\n    return()\n  }\n  print(outcomes)\n  data <- values$sid.data$data\n  ui <- lapply(X = outcomes, FUN = function(y){\n    col <- data[, y, with = FALSE]\n    if (is.factor(col)) {\n      guess_type  <- \"binary\"\n    } else if ((is.numeric(col) || is.integer(col)) && round(col) == col) {\n      guess_type  <- \"count\"\n    } else {\n      guess_type <- \"numeric\"\n    }\n    selectInput(inputId = paste(\"type\", y, sep = \"_\"), \n                label = paste(\"Type of\", y), \n                choices = OUTCOME_TYPES, \n                selected = guess_type, \n                multiple = FALSE)\n  })\n  ui <- list(h2(\"Outcome types\"), ui)\n})\n\n# update selectOutcomeTypes panel\nonevent(\n  event = \"mouseleave\",\n  id = \"selectOutcomes\",\n  expr = {\n    outcomes <- input$selectOutcomes\n    \n    if (trt != \"\") {\n      updateSelectInput(\n        session, \n        inputId = \"selectControl\", \n        choices = unique(as.vector(values$sid.data$data[, trt, with = FALSE])))\n    } else {\n      updateSelectInput(\n        session, \n        inputId = \"selectControl\", \n        choices = c())\n    }\n    updateFeatureSelect()\n  }\n)\n\nonevent(\n  event = \"mouseleave\",\n  id = \"selectContrast\",\n  expr = {\n    trt <- input$selectContrast\n    if (trt != \"\") {\n      updateSelectInput(\n        session, \n        inputId = \"selectControl\", \n        choices = unique(as.vector(values$sid.data$data[, trt, with = FALSE])))\n    } else {\n      updateSelectInput(\n        session, \n        inputId = \"selectControl\", \n        choices = c())\n    }\n    updateFeatureSelect()\n  }\n)\n\nonevent(\n  event = \"mouseup\",\n  id = \"selectCovariates\",\n  expr = {\n    updateFeatureSelect()\n  }\n)\nonevent(\n  event = \"mouseup\",\n  id = \"selectOutcomes\",\n  expr = {\n    updateFeatureSelect()\n  }\n)\n\nupdateFeatureSelect <- function () {\n  features <- colnames(values$sid.data$data)\n  updateSelectInput(session, \n                    inputId = \"selectContrast\", \n                    choices = c(\"\", setdiff(features, c(input$selectCovariates, input$selectOutcomes))),\n                    selected = input$selectContrast)\n  \n  updateMultiInput(session, \n                   inputId = \"selectCovariates\", \n                   choices = setdiff(features, c(input$selectContrast, input$selectOutcomes)),\n                   selected = input$selectCovariates)\n  updateMultiInput(session, \n                   inputId = \"selectOutcomes\", \n                   choices = setdiff(features, c(input$selectContrast, input$selectCovariates)),\n                   selected = input$selectOutcomes)\n}\n    \n\nonclick(\n  id = \"SaveFeatureSelect\", \n  expr = {\n    values$sid.data <-\n      loadDataset(dataset = values$sid.data$data, \n                  trt = input$selectContrast, \n                  ctrl = input$selectControl,\n                  covariates = input$selectCovariates,\n                  outcomes = input$selectOutcomes,\n                  rules = values$sid.data$rules)\n})\n\nonclick(\n  id = \"loadData\", \n  \n  expr = {\n    print(input$dataPath)\n    print(input$dataPath$dataPath)\n    tryCatch(\n      expr = {\n        data <- fread(input$dataPath$datapath, stringsAsFactors = T)\n        # remove missing data\n        idx <- apply(X = data, MARGIN = 1, FUN = function(row){\n          sum(is.na(row) == 0)\n        })\n        showNotification(paste0(\"data loaded dim=\", dim(data)))\n        data <- data[idx,]\n        values$sid.data$data <- data\n        shinyjs::show(\"SaveFeatureSelect\")\n      }, \n      error = function(e) {\n        print(e)\n      }\n    )\n  }\n)\n\nonclick(\n  id = \"simulateData\",\n  expr = {\n    shinyjs::show(id = \"ruleSummary\")\n    # parse covariates_normal areatext\n    str_normal <- unlist(strsplit(\n      x = str_replace_all(string = input$covariates_normal, \n                          pattern = \"[()]\", \n                          replacement = \"\"),\n      split = \"\\n\"))\n    covariates_normal <-\n      lapply(X = str_normal, FUN = function(str){\n        as.numeric(unlist(strsplit(x = str, split = \",\")))\n    })\n    print(covariates_normal)\n    # parse covariates_uniform areatext\n    str_uniform <- unlist(strsplit(\n      x = str_replace_all(string = input$covariates_uniform, \n                          pattern = \"[()]\", \n                          replacement = \"\"),\n      split = \"\\n\"))\n    covariates_uniform <-\n      lapply(X = str_uniform, FUN = function(str){\n        as.numeric(unlist(strsplit(x = str, split = \",\")))\n      })\n    print(covariates_uniform)\n    # parse covariates_binomial areatext\n    str_binomial <- unlist(strsplit(\n      x = str_replace_all(string = input$covariates_binomial, \n                          pattern = \"[()]\", \n                          replacement = \"\"),\n      split = \"\\n\"))\n    covariates_binomial <-\n      lapply(X = str_binomial, FUN = function(str){\n        as.numeric(unlist(strsplit(x = str, split = \",\")))\n      })\n    print(covariates_binomial)\n    # parse covariates_binary areatext\n    covariates_binary <- \n      as.numeric(\n        unlist(\n          strsplit(x = input$covariates_binary, \n                   split = \"\\n\")))\n    print(covariates_binary)\n    # parse correlation areatext\n    correlation <- \n      as.numeric(\n        unlist(\n          strsplit(x = input$correlation, \n                   split = \"\\n\")))\n    print(correlation)\n    print(list(\n      N = input$N_samples,\n      case = input$case, \n      overal_treatment_effect = input$overal_treatment_effect, \n      subgroup_enhanced_effect = input$subgroup_enhanced_effect, \n      subgroup_shift_effect = input$subgroup_shift_effect,\n      subgroup_ratio = input$subgroup_ratio, \n      covariates_normal = covariates_normal,\n      covariates_uniform = covariates_uniform, \n      covariates_binomial = covariates_binomial, \n      covariates_binary = covariates_binary, \n      treatment_p = input$treatment_p, \n      rule_depth = input$rule_depth,\n      correlation = correlation, \n      SD_NOISE_RATIO = input$SD_NOISE_RATIO, \n      has_FP = input$has_FP\n    ))\n    values$sid.data <- \n      simulateSubgroupData(\n        N = input$N_samples,\n        case = input$case, \n        overal_treatment_effect = input$overal_treatment_effect, \n        subgroup_enhanced_effect = input$subgroup_enhanced_effect, \n        subgroup_shift_effect = input$subgroup_shift_effect,\n        subgroup_ratio = input$subgroup_ratio, \n        covariates_normal = covariates_normal,\n        covariates_uniform = covariates_uniform, \n        covariates_binomial = covariates_binomial, \n        covariates_binary = covariates_binary, \n        treatment_p = input$treatment_p, \n        rule_depth = input$rule_depth,\n        correlation = correlation, \n        SD_NOISE_RATIO = input$SD_NOISE_RATIO, \n        has_FP = input$has_FP\n      )\n    #print(dim(values$sid.data$data))\n    shinyjs::show(\"SaveFeatureSelect\")\n  }\n)\n\noutput$featureSummary <- renderPrint({\n  if(\"data\" %in% names(values$sid.data) &&\n     nrow(values$sid.data$data) > 0) {\n    summary(values$sid.data$data)\n  } else {\n    \"No data loaded.\"\n  }\n})\n\noutput$ruleSummary <- renderDataTable({\n  values$sid.data$rules\n})\noutput$selectContrast <- renderUI({\n  selectInput(inputId = \"inputContrast\", \n              label = \"select contrast feature\", \n              choices = colnames(values$sid.data$data))\n})\n\n",
    "created" : 1565382837569.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3720466794",
    "id" : "5BA123EA",
    "lastKnownWriteTime" : 1565385790,
    "last_content_update" : 1565385875399,
    "path" : "~/sidtoolbox/inst/shiny-examples/sidApp/src/server_setup.R",
    "project_path" : "inst/shiny-examples/sidApp/src/server_setup.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}